# Intrascribe Microservices Makefile
# Commands for managing the microservices infrastructure

.PHONY: help build up down logs clean dev test health init agent agent-stop agent-scale status stats info quickstart

# Default target
help:
	@echo "Intrascribe Microservices Management"
	@echo ""
	@echo "Available commands:"
	@echo ""
	@echo "ğŸš€ Quick Start:"
	@echo "  quickstart - Complete setup for new developers"
	@echo "  init      - Initialize development environment"
	@echo "  up        - Start all services"
	@echo "  health    - Check service health status"
	@echo ""
	@echo "ğŸ”§ Development:"
	@echo "  build     - Build all Docker images"
	@echo "  dev       - Start development environment (with rebuild)"
	@echo "  logs      - Show logs from all services"
	@echo "  stats     - Show resource usage statistics"
	@echo ""
	@echo "ğŸ§ Agent Management:"
	@echo "  agent     - Start LiveKit agent manually"
	@echo "  agent-stop - Stop LiveKit agent"
	@echo "  agent-scale - Scale agent instances"
	@echo ""
	@echo "ğŸ› ï¸  Service Management:"
	@echo "  status    - Show service status"
	@echo "  restart-<service> - Restart specific service"
	@echo "  logs-<service> - Show logs for specific service"
	@echo "  update-<service> - Update and rebuild specific service"
	@echo ""
	@echo "ğŸ§¹ Cleanup:"
	@echo "  down      - Stop all services"
	@echo "  clean     - Clean up containers and volumes"
	@echo ""
	@echo "ğŸ“Š Monitoring:"
	@echo "  test      - Run health checks on all services"
	@echo "  info      - Show detailed service information"
	@echo ""

# Build all Docker images
build:
	@echo "ğŸ”¨ Building Docker images..."
	docker-compose build

# Start all services
up:
	@echo "ğŸš€ Starting all microservices..."
	docker-compose up -d --remove-orphans
	@echo "âœ… All services started"
	@echo "ğŸ“Š API Service: http://localhost:8000"
	@echo "ğŸ™ï¸  STT Service: http://localhost:8001"
	@echo "ğŸ‘¥ Diarization Service: http://localhost:8002"

# Stop all services
down:
	@echo "ğŸ›‘ Stopping all microservices..."
	docker-compose down
	@echo "âœ… All services stopped"

# Show logs from all services
logs:
	docker-compose logs -f

# Show logs from specific service
logs-%:
	docker-compose logs -f $*

# Clean up containers and volumes
clean:
	@echo "ğŸ§¹ Cleaning up containers and volumes..."
	docker-compose down -v --remove-orphans
	docker system prune -f
	@echo "âœ… Cleanup completed"

# Start development environment (with rebuilding)
dev:
	@echo "ğŸ”§ Starting development environment..."
	docker-compose up -d --build
	@echo "âœ… Development environment ready"

# Run health checks
test: health

# Check service health
health:
	@echo "ğŸ¥ Checking service health..."
	@echo ""
	@echo "ğŸ“Š API Service (Port 8000):"
	@curl -s http://localhost:8000/health 2>/dev/null | python -m json.tool 2>/dev/null || echo "âŒ API Service not responding"
	@echo ""
	@echo "ğŸ™ï¸  STT Service (Port 8001):"
	@curl -s http://localhost:8001/health 2>/dev/null | python -m json.tool 2>/dev/null || echo "âŒ STT Service not responding"
	@echo ""
	@echo "ğŸ‘¥ Diarization Service (Port 8002):"
	@curl -s http://localhost:8002/health 2>/dev/null | python -m json.tool 2>/dev/null || echo "âŒ Diarization Service not responding"
	@echo ""
	@echo "ğŸ’¾ Redis Status:"
	@docker-compose exec redis redis-cli ping 2>/dev/null || echo "âŒ Redis not responding"
	@echo ""

# Start Agent service manually
agent:
	@echo "ğŸ§ Starting Agent service..."
	docker-compose up -d agent-service
	@echo "âœ… Agent service started"

# Stop Agent service
agent-stop:
	@echo "ğŸ›‘ Stopping Agent service..."
	docker-compose stop agent-service
	@echo "âœ… Agent service stopped"

# Scale LiveKit agents
agent-scale:
	@echo "ğŸ“ˆ Scaling LiveKit agents..."
	@read -p "Number of agent instances: " count; \
	docker-compose up -d --scale agent-service=$$count agent-service

# Show service status
status:
	@echo "ğŸ“Š Service Status:"
	@docker-compose ps

# Restart specific service
restart-%:
	@echo "ğŸ”„ Restarting $* service..."
	docker-compose restart $*
	@echo "âœ… $* service restarted"

# View service logs in real-time
tail-%:
	docker-compose logs -f --tail=100 $*

# Run a command in a service container
exec-%:
	@echo "ğŸ’» Entering $* container..."
	docker-compose exec $* bash

# Update and rebuild a specific service
update-%:
	@echo "ğŸ”„ Updating $* service..."
	docker-compose build $*
	docker-compose up -d $*
	@echo "âœ… $* service updated"

# Initialize development environment
init:
	@echo "ğŸ—ï¸  Initializing development environment..."
	@if [ ! -f .env ]; then \
		echo "ğŸ“ Creating .env file from template..."; \
		if [ -f .env.example ]; then \
			cp .env.example .env; \
		else \
			echo "âš ï¸  .env.example not found, creating basic .env file"; \
			echo "# Please configure the following environment variables" > .env; \
			echo "SUPABASE_URL=http://127.0.0.1:54321" >> .env; \
			echo "SUPABASE_ANON_KEY=your-supabase-anon-key" >> .env; \
			echo "SUPABASE_SERVICE_ROLE_KEY=your-supabase-service-role-key" >> .env; \
			echo "LIVEKIT_API_URL=wss://your-livekit-instance.livekit.cloud" >> .env; \
			echo "LIVEKIT_API_KEY=your-livekit-api-key" >> .env; \
			echo "LIVEKIT_API_SECRET=your-livekit-api-secret" >> .env; \
			echo "HUGGINGFACE_TOKEN=hf_your-huggingface-token" >> .env; \
		fi; \
		echo "âš ï¸  Please edit .env file with your actual configuration"; \
	else \
		echo "âœ… .env file already exists"; \
	fi
	@echo "ğŸ”¨ Building images..."
	make build
	@echo "âœ… Initialization completed"

# Show resource usage
stats:
	@echo "ğŸ“Š Resource Usage Statistics:"
	@echo ""
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}" || echo "âŒ Failed to get stats"

# Show detailed service info
info:
	@echo "â„¹ï¸  Service Information:"
	@echo ""
	@echo "ğŸ“Š API Service Info:"
	@curl -s http://localhost:8000/info 2>/dev/null | python -m json.tool 2>/dev/null || echo "âŒ API Service info not available"
	@echo ""
	@echo "ğŸ™ï¸  STT Service Info:"
	@curl -s http://localhost:8001/info 2>/dev/null | python -m json.tool 2>/dev/null || echo "âŒ STT Service info not available"
	@echo ""
	@echo "ğŸ‘¥ Diarization Service Info:"
	@curl -s http://localhost:8002/info 2>/dev/null | python -m json.tool 2>/dev/null || echo "âŒ Diarization Service info not available"

# Quick setup for new developers
quickstart:
	@echo "ğŸš€ Quick Start for New Developers:"
	@echo ""
	@echo "1. Initializing environment..."
	@make init
	@echo ""
	@echo "2. Starting all services..."
	@make up
	@echo ""
	@echo "3. Waiting for services to start..."
	@sleep 10
	@echo ""
	@echo "4. Checking health..."
	@make health
	@echo ""
	@echo "âœ… Setup complete! Services available at:"
	@echo "   ğŸ“Š API Service: http://localhost:8000/docs"
	@echo "   ğŸ™ï¸  STT Service: http://localhost:8001/docs"
	@echo "   ğŸ‘¥ Diarization Service: http://localhost:8002/docs"
